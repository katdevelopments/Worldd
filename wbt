print("WBT Mobile Script Initialized")

local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

local WBT_SETTINGS = {
    WebsiteBaseUrl = "https://worldbt.netlify.app",
    SubmitApiUrl = "https://worldbt.netlify.app/.netlify/functions/submit-scan",
    LogLevel = "Info",
    UseGui = true,
    AutoCopyLink = false,
}

local WBT = {}
WBT.Info = { Executor = "Unknown", Version = "N/A", Level = "N/A" }
WBT.Results = {}
WBT.Logs = {}
WBT.Stats = { Total = 0, Passed = 0 }

-- // UI THEME CONFIG (Pitch Black Theme) // --
local THEME = {
    Background = Color3.fromRGB(0, 0, 0),          -- Pitch Black
    Header = Color3.fromRGB(0, 0, 0),              -- Pitch Black
    ContentBg = Color3.fromRGB(0, 0, 0),           -- Pitch Black
    Text = Color3.fromRGB(255, 255, 255),          -- Pure White
    SubText = Color3.fromRGB(180, 180, 180),       -- Light Gray
    Stroke = Color3.fromRGB(80, 80, 80),           -- Dark Gray Stroke
    Button = Color3.fromRGB(40, 40, 40),           -- Dark Gray Button
    Green = Color3.fromRGB(100, 255, 100),         -- Pass
    Red = Color3.fromRGB(255, 80, 80),             -- Fail
    Yellow = Color3.fromRGB(255, 215, 0),          -- Unsupported
}

-- // LOGGING // --
local function Log(level, ...)
    local message = table.concat({...}, " ")
    table.insert(WBT.Logs, {Level = level, Message = message, Time = os.time()})
    
    local levels = {Debug = 0, Info = 1, Warn = 2, Error = 3}
    if (levels[level] or 1) < (levels[WBT_SETTINGS.LogLevel] or 1) then return end

    local prefix = "[WBT " .. level:upper() .. "]"
    if rconsoleprint then
        pcall(rconsoleprint, prefix .. " " .. message .. "\n")
    else
        print(prefix, message)
    end
end

-- // GUI SYSTEM // --
local GUI = {}
GUI.ScreenGui = nil
GUI.MainFrame = nil
GUI.ContentFrame = nil
GUI.LogList = nil
GUI.ResultsFrame = nil
GUI.ProgressBar = nil
GUI.ProgressFill = nil
GUI.StatusLabel = nil
GUI.PercentageLabel = nil
GUI.ReviewButton = nil

local function Tween(obj, props, time, style, dir)
    if not obj then return end
    local info = TweenInfo.new(time or 0.6, style or Enum.EasingStyle.Exponential, dir or Enum.EasingDirection.Out)
    local tween = TweenService:Create(obj, info, props)
    tween:Play()
    return tween
end

local function Create(class, props, children)
    local obj = Instance.new(class)
    for k, v in pairs(props or {}) do
        obj[k] = v
    end
    for _, child in pairs(children or {}) do
        child.Parent = obj
    end
    return obj
end

function GUI:Create()
    if not WBT_SETTINGS.UseGui then return end
    if GUI.ScreenGui then GUI.ScreenGui:Destroy() end

    local parent = gethui and gethui() or game:GetService("CoreGui")

    -- Main GUI
    GUI.ScreenGui = Create("ScreenGui", {
        Name = "WBT_Mobile_UI",
        Parent = parent,
        ResetOnSpawn = false,
        DisplayOrder = 999
    })

    -- Main Container
    GUI.MainFrame = Create("Frame", {
        Name = "MainFrame",
        AnchorPoint = Vector2.new(0.5, 0.5),
        Position = UDim2.fromScale(0.5, 0.5),
        Size = UDim2.fromScale(0, 0), -- Start small for tween
        BackgroundColor3 = THEME.Background,
        BorderSizePixel = 0,
        ClipsDescendants = true,
        Parent = GUI.ScreenGui
    }, {
        Create("UICorner", { CornerRadius = UDim.new(0, 10) }),
        Create("UIStroke", { Color = THEME.Stroke, Thickness = 2, Transparency = 0.5 }),
        -- Size Constraint: Fills screen on mobile, limits size on PC
        Create("UISizeConstraint", {
            MaxSize = Vector2.new(600, 450),
            MinSize = Vector2.new(320, 250)
        })
    })

    Tween(GUI.MainFrame, { Size = UDim2.fromScale(0.9, 0.65) }, 0.8, Enum.EasingStyle.Elastic)

    -- Header
    local header = Create("Frame", {
        Name = "Header",
        Size = UDim2.new(1, 0, 0, 40),
        BackgroundColor3 = THEME.Header,
        BorderSizePixel = 0,
        Parent = GUI.MainFrame
    }, {
        Create("TextLabel", {
            Text = "WBT Benchmark",
            Font = Enum.Font.GothamBold,
            TextSize = 16,
            TextColor3 = THEME.Text,
            Size = UDim2.new(1, -50, 1, 0),
            Position = UDim2.new(0, 15, 0, 0),
            BackgroundTransparency = 1,
            TextXAlignment = Enum.TextXAlignment.Left
        })
    })

    -- Close Button
    local closeBtn = Create("TextButton", {
        Text = "×",
        Font = Enum.Font.GothamMedium,
        TextSize = 24,
        TextColor3 = THEME.SubText,
        BackgroundTransparency = 1,
        Size = UDim2.new(0, 40, 1, 0),
        Position = UDim2.new(1, -40, 0, 0),
        Parent = header
    })
    closeBtn.MouseButton1Click:Connect(function()
        Tween(GUI.MainFrame, { Size = UDim2.fromScale(0, 0), Position = UDim2.fromScale(0.5, 0.6) }, 0.4, Enum.EasingStyle.Back, Enum.EasingDirection.In)
        task.wait(0.4)
        GUI.ScreenGui:Destroy()
    end)

    -- Content Area
    GUI.ContentFrame = Create("Frame", {
        Name = "Content",
        Size = UDim2.new(1, -20, 1, -100),
        Position = UDim2.new(0, 10, 0, 50),
        BackgroundTransparency = 1,
        ClipsDescendants = true,
        Parent = GUI.MainFrame
    })

    -- Footer / Progress Area
    local footer = Create("Frame", {
        Name = "Footer",
        Size = UDim2.new(1, -20, 0, 40),
        Position = UDim2.new(0, 10, 1, -50),
        BackgroundTransparency = 1,
        Parent = GUI.MainFrame
    })

    GUI.StatusLabel = Create("TextLabel", {
        Text = "Initializing...",
        Font = Enum.Font.Gotham,
        TextSize = 13,
        TextColor3 = THEME.SubText,
        Size = UDim2.new(0.7, 0, 0.5, 0),
        BackgroundTransparency = 1,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = footer
    })

    GUI.PercentageLabel = Create("TextLabel", {
        Text = "0%",
        Font = Enum.Font.GothamBold,
        TextSize = 13,
        TextColor3 = THEME.Text,
        Size = UDim2.new(0.3, 0, 0.5, 0),
        Position = UDim2.new(0.7, 0, 0, 0),
        BackgroundTransparency = 1,
        TextXAlignment = Enum.TextXAlignment.Right,
        Parent = footer
    })

    GUI.ProgressBar = Create("Frame", {
        Name = "BarBg",
        Size = UDim2.new(1, 0, 0, 6),
        Position = UDim2.new(0, 0, 0.7, 0),
        BackgroundColor3 = Color3.fromRGB(40, 40, 40),
        Parent = footer
    }, { Create("UICorner", { CornerRadius = UDim.new(1, 0) }) })

    GUI.ProgressFill = Create("Frame", {
        Name = "Fill",
        Size = UDim2.new(0, 0, 1, 0),
        BackgroundColor3 = THEME.Text,
        Parent = GUI.ProgressBar
    }, { 
        Create("UICorner", { CornerRadius = UDim.new(1, 0) }),
        Create("UIGradient", { Color = ColorSequence.new(Color3.fromRGB(200, 200, 200), Color3.fromRGB(255, 255, 255)) })
    })

    GUI.ReviewButton = Create("TextButton", {
        Text = "Show Results",
        Font = Enum.Font.GothamBold,
        TextSize = 12,
        TextColor3 = THEME.Background,
        BackgroundColor3 = THEME.SubText,
        Size = UDim2.new(0, 100, 0, 25),
        AnchorPoint = Vector2.new(1, 1),
        Position = UDim2.new(1, 0, -0.2, 0),
        Visible = false,
        Parent = footer
    }, { Create("UICorner", { CornerRadius = UDim.new(0, 4) }) })

    GUI.ReviewButton.MouseButton1Click:Connect(function()
        if GUI.ResultsFrame and GUI.ResultsFrame.Visible then
             GUI:ToggleView("logs")
        else
             GUI:ToggleView("results")
        end
    end)

    -- Dragging
    local dragging, dragInput, dragStart, startPos
    local function update(input)
        local delta = input.Position - dragStart
        GUI.MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
    header.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = GUI.MainFrame.Position
            input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then dragging = false end end)
        end
    end)
    header.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then dragInput = input end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then update(input) end
    end)
end

function GUI:ToggleView(view)
    if not GUI.ResultsFrame or not GUI.LogList then return end
    if view == "results" then
        Tween(GUI.LogList, {Position = UDim2.new(1, 0, 0, 0)}, 0.4, Enum.EasingStyle.Exponential, Enum.EasingDirection.Out)
        task.wait(0.1)
        GUI.ResultsFrame.Visible = true
        GUI.ReviewButton.Text = "Review Logs"
        Tween(GUI.ResultsFrame, {BackgroundTransparency = 0}, 0.3)
    else
        GUI.ResultsFrame.Visible = false
        GUI.LogList.Visible = true
        GUI.ReviewButton.Text = "Show Results"
        Tween(GUI.LogList, {Position = UDim2.new(0, 0, 0, 0)}, 0.4, Enum.EasingStyle.Exponential, Enum.EasingDirection.Out)
    end
end

function GUI:ShowWarning(callback)
    local container = Create("Frame", {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Parent = GUI.ContentFrame
    })

    Create("TextLabel", { Text = "⚠️", TextSize = 40, Size = UDim2.new(1, 0, 0.3, 0), BackgroundTransparency = 1, Parent = container })

    Create("TextLabel", {
        Text = "Heads up!", Font = Enum.Font.GothamBold, TextSize = 22, TextColor3 = THEME.Text,
        Size = UDim2.new(1, 0, 0.2, 0), Position = UDim2.new(0, 0, 0.25, 0), BackgroundTransparency = 1, Parent = container
    })

    Create("TextLabel", {
        Text = "The execution will freeze briefly.\nDo not close the script.",
        Font = Enum.Font.Gotham, TextSize = 14, TextColor3 = THEME.SubText,
        Size = UDim2.new(0.9, 0, 0.3, 0), Position = UDim2.new(0.05, 0, 0.45, 0), BackgroundTransparency = 1, TextWrapped = true, Parent = container
    })

    local btn = Create("TextButton", {
        Text = "Start Benchmark", Font = Enum.Font.GothamBold, TextSize = 14,
        TextColor3 = THEME.Background, BackgroundColor3 = THEME.Text,
        Size = UDim2.new(0.6, 0, 0.15, 0), Position = UDim2.new(0.2, 0, 0.8, 0), Parent = container
    }, { Create("UICorner", { CornerRadius = UDim.new(0, 6) }) })

    btn.MouseButton1Click:Connect(function()
        Tween(container, {Position = UDim2.new(-1, 0, 0, 0)}, 0.5, Enum.EasingStyle.Exponential)
        task.wait(0.3)
        container:Destroy()
        callback()
    end)
end

function GUI:CreateLogView()
    GUI.LogList = Create("ScrollingFrame", {
        Size = UDim2.new(1, 0, 1, 0),
        Position = UDim2.new(1, 0, 0, 0),
        BackgroundTransparency = 1,
        ScrollBarThickness = 3,
        ScrollBarImageColor3 = THEME.SubText,
        AutomaticCanvasSize = Enum.AutomaticSize.Y,
        CanvasSize = UDim2.new(0, 0, 0, 0),
        Parent = GUI.ContentFrame
    }, { Create("UIListLayout", { SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 4) }) })
    Tween(GUI.LogList, {Position = UDim2.new(0, 0, 0, 0)}, 0.5, Enum.EasingStyle.Exponential)
end

function GUI:AddLogEntry(testName, status)
    if not GUI.LogList then return end
    local color, symbol = THEME.SubText, "•"
    if status == "pass" then color, symbol = THEME.Green, "✓"
    elseif status == "fail" then color, symbol = THEME.Red, "✗"
    elseif status == "unsupported" then color, symbol = THEME.Yellow, "?" end

    local row = Create("Frame", { Size = UDim2.new(1, 0, 0, 22), BackgroundTransparency = 1, Parent = GUI.LogList, LayoutOrder = #GUI.LogList:GetChildren() })
    Create("TextLabel", { Text = symbol, TextColor3 = color, Font = Enum.Font.GothamBold, TextSize = 14, Size = UDim2.new(0, 20, 1, 0), BackgroundTransparency = 1, Parent = row })
    Create("TextLabel", { Text = testName, TextColor3 = color, Font = Enum.Font.Gotham, TextSize = 12, Size = UDim2.new(1, -25, 1, 0), Position = UDim2.new(0, 25, 0, 0), BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Left, Parent = row })
    GUI.LogList.CanvasPosition = Vector2.new(0, 99999)
end

function GUI:UpdateProgress(passed, total, currentTest)
    if total == 0 then return end
    local completion = WBT.Stats.Total / 125
    Tween(GUI.ProgressFill, {Size = UDim2.new(math.min(completion, 1), 0, 1, 0)}, 0.2)
    GUI.PercentageLabel.Text = math.floor((passed / math.max(total, 1)) * 100) .. "%"
    if currentTest then GUI.StatusLabel.Text = "Running: " .. currentTest end
end

function GUI:ShowLink(url)
    if not GUI.ContentFrame then return end
    if GUI.LogList then Tween(GUI.LogList, {Position = UDim2.new(1, 0, 0, 0)}, 0.5, Enum.EasingStyle.Exponential, Enum.EasingDirection.Out) end
    
    -- Ensure explicit Pitch Black background for the results container
    GUI.ResultsFrame = Create("Frame", {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        BackgroundColor3 = THEME.Background, 
        Parent = GUI.ContentFrame
    })

    Create("TextLabel", { Text = "Benchmark Complete", Font = Enum.Font.GothamBold, TextSize = 18, TextColor3 = THEME.Text, Size = UDim2.new(1, 0, 0.2, 0), BackgroundTransparency = 1, Parent = GUI.ResultsFrame })

    local box = Create("TextBox", {
        Text = url, Font = Enum.Font.Code, TextSize = 12, TextColor3 = THEME.Text,
        BackgroundColor3 = THEME.Background, -- PITCH BLACK
        Size = UDim2.new(1, 0, 0.25, 0), Position = UDim2.new(0, 0, 0.3, 0),
        ClearTextOnFocus = false, TextEditable = false, TextWrapped = true, Parent = GUI.ResultsFrame
    }, { Create("UICorner", {CornerRadius = UDim.new(0, 6)}), Create("UIStroke", {Color = THEME.Stroke, Thickness = 1}) })
    
    local copyBtn = Create("TextButton", {
        Text = "Copy Link", Font = Enum.Font.GothamBold, TextSize = 14,
        TextColor3 = THEME.Background, BackgroundColor3 = THEME.Text,
        Size = UDim2.new(0.6, 0, 0.15, 0), Position = UDim2.new(0.2, 0, 0.7, 0), Parent = GUI.ResultsFrame
    }, { Create("UICorner", {CornerRadius = UDim.new(0, 6)}) })
    
    copyBtn.MouseButton1Click:Connect(function()
        if setclipboard then
            setclipboard(url)
            copyBtn.Text = "Copied!"
            Tween(copyBtn, {BackgroundColor3 = THEME.Green}, 0.3)
            task.wait(1)
            copyBtn.Text = "Copy Link"
            Tween(copyBtn, {BackgroundColor3 = THEME.Text}, 0.3)
        else
            copyBtn.Text = "Not Supported"
        end
    end)
    
    if GUI.ReviewButton then
        GUI.ReviewButton.Visible = true
        GUI.ReviewButton.Text = "Review Logs"
    end
    
    GUI.StatusLabel.Text = "Finished."
    Tween(GUI.ProgressFill, {Size = UDim2.new(1, 0, 1, 0)}, 0.5)
    Tween(GUI.ResultsFrame, {BackgroundTransparency = 0}, 0.5)
end

-- // CORE LOGIC // --
WBT.Test = {}

local AllTestsOrdered = {
    "getgenv", "getrenv", "getreg", "getgc", "getinstances", "getnilinstances", "getscripts", "getloadedmodules", "getconnections", "getthreadidentity", "setthreadidentity", "setthreadidentity (behavior)", "firesignal", "fireclickdetector", "firetouchinterest", "is_executor_closure", "is_syn_closure", "checkcaller", "loadstring (behavior)",
    "getchildren", "getdescendants", "findfirstchild", "findfirstchildofclass", "findfirstancestor",
    "require (existence)", "require (behavior)",
    "writefile", "readfile", "appendfile", "loadfile", "listfiles", "isfile", "isfolder", "makefolder", "delfile", "delfolder", "FS I/O Test",
    "getrawmetatable", "setrawmetatable", "getmetatable", "setmetatable", "setreadonly", "isreadonly", "getnamecallmethod", "setnamecallmethod", "hookfunction", "hookfunction (C function)", "hookmetamethod (behavior)", "clonefunction", "newcclosure",
    "debug.getconstants", "debug.getupvalues", "debug.setupvalue", "debug.get/setupvalue (behavior)", "debug.getproto", "debug.setstack", "debug.getmetatable", "debug.setmetatable", "debug.getfenv", "debug.setfenv",
    "rconsoleprint", "rconsoleinfo", "rconsolewarn", "rconsoleerr", "rconsoleclear", "rconsolename", "rconsoleinput",
    "print", "warn", "error", "pcall",
    "keypress", "keyrelease", "mouse1click", "mouse1press", "mouse1release", "mouse1click (behavior)", "mouse2click", "mouse2press", "mouse2release", "mousescroll", "mousemoveabs", "mousemoverel",
    "crypt.encrypt", "crypt.decrypt", "crypt.hash (md5)", "crypt.hash (sha256)", "base64.encode", "base64.decode", "lz4.compress", "lz4.decompress",
    "Drawing.new(Line)", "Drawing.new(Text)", "Drawing.new(Image)", "Drawing.new(Circle)", "Drawing.new(Square)", "Drawing.new(Quad)", "Drawing.new(Triangle)", "Drawing Properties",
    "getscriptbytecode", "getscripthash", "gethui", "cloneref", "queue_on_teleport", "setclipboard", "getclipboard", "set/getclipboard (behavior)", "getcustomasset", "secure_call", "secure_call (behavior)", "getinstancein", "getinstancesin",
    "identifyexecutor", "getexecutorname",
    "bit.band", "bit.bor", "bit.bxor", "bit.lshift", "bit.rshift", "bit.arshift", "bit.not",
    "http_request", "request", "http.get", "http.post",
    "websocket.connect", "websocket.send", "websocket.close", "websocket.on_message", "websocket.on_error",
    "os.execute", "os.remove", "os.rename", "os.exit", "os.clock",
    "io.open", "io.read", "io.write", "io.popen",
    "coroutine.create", "coroutine.resume", "coroutine.yield", "coroutine.wrap",
    "collectgarbage",
    "newinstance.new", "newinstance.create",
    "read_virtual_memory", "write_virtual_memory", "readvmem", "writevmem", "find_pattern", "aob_scan",
    "sethiddenproperty", "gethiddenproperty", "Protected Property Bypass", "ParentLock Bypass",
    "getcallingscript", "getscriptfromthread", "getthreadcontext", "setthreadcontext",
    "luau_load", "iscclosure", "islcclosure",
    "get_fps_cap", "set_fps_cap", "is_synapse_environment", "is_krnl_environment", "is_scriptware_environment", "User-Agent Spoofing",
    "HttpGet", "HttpPost", "GetObjects", "UserSettings", "Stats",
    "debug.debug", "Instance Hiding (getchildren)",
    "Hook Speed", "GC Speed", "Instance Creation Speed"
}

function WBT.Test:Run(category, name, testFunc)
    if not WBT.Results[category] then WBT.Results[category] = {} end
    WBT.Stats.Total = WBT.Stats.Total + 1
    
    pcall(GUI.UpdateProgress, GUI, WBT.Stats.Passed, WBT.Stats.Total, name)
    local status, result = pcall(testFunc)
    local testStatus
    if not status then testStatus = "fail"
    elseif result == "unsupported" then testStatus = "unsupported"
    elseif result == true then testStatus = "pass"; WBT.Stats.Passed = WBT.Stats.Passed + 1
    else testStatus = "fail" end
    
    pcall(GUI.AddLogEntry, GUI, name, testStatus)
    WBT.Results[category][name] = testStatus
    task.wait(0.01) -- Prevent freezing
end

function WBT:GetExecutorInfo()
    local s, name, ver = pcall(identifyexecutor)
    if s and type(name) == "string" then
        WBT.Info.Executor = name
        if ver then WBT.Info.Version = tostring(ver) else
            local s_ver, ver_alt = pcall(getexecutorversion)
            if s_ver and ver_alt then WBT.Info.Version = tostring(ver_alt) end
        end
    else
        s, name = pcall(getexecutorname)
        if s and type(name) == "string" then WBT.Info.Executor = name
        elseif _G._VERSION then WBT.Info.Executor = _G._VERSION end
    end
    local s_level, level = pcall(getthreadidentity)
    if s_level and level then WBT.Info.Level = tostring(level) end
end

-- Safely attaching RunAllTests to WBT
WBT.RunAllTests = function(self)
    self:GetExecutorInfo()
    local T = self.Test
    local function Run(cat, name, func) T:Run(cat, name, func) end

    local category = "Core Environment"
    Run(category, "getgenv", function() return getgenv and type(getgenv()) == "table" and getgenv()._G == _G end)
    Run(category, "getrenv", function() return getrenv and type(getrenv()) == "table" and getrenv().game == game end)
    Run(category, "getreg", function() return getreg and type(getreg()) == "table" end)
    Run(category, "getgc", function() return getgc and type(getgc()) == "table" end)
    Run(category, "getinstances", function() return getinstances and type(getinstances()) == "table" end)
    Run(category, "getnilinstances", function() return getnilinstances and type(getnilinstances()) == "table" end)
    Run(category, "getscripts", function() return getscripts and type(getscripts()) == "table" end)
    Run(category, "getloadedmodules", function() return getloadedmodules and type(getloadedmodules()) == "table" end)
    Run(category, "getconnections", function() return getconnections and type(getconnections(game:GetService("RunService").Heartbeat)) == "table" end)
    Run(category, "getthreadidentity", function() return getthreadidentity and type(getthreadidentity()) == "number" end)
    Run(category, "setthreadidentity", function() 
        if not setthreadidentity then return "unsupported" end
        pcall(setthreadidentity, 7); pcall(setthreadidentity, 2)
        return true
    end)
    Run(category, "setthreadidentity (behavior)", function()
        if not getthreadidentity or not setthreadidentity then return "unsupported" end
        local old = getthreadidentity()
        setthreadidentity(8); local new = getthreadidentity()
        setthreadidentity(old); return new == 8
    end)
    Run(category, "firesignal", function() return not not firesignal end)
    Run(category, "fireclickdetector", function() return not not fireclickdetector end)
    Run(category, "firetouchinterest", function() return not not firetouchinterest end)
    Run(category, "is_executor_closure", function() return not not is_executor_closure end)
    Run(category, "checkcaller", function() return checkcaller and type(checkcaller()) == "boolean" end)
    Run(category, "loadstring (behavior)", function()
        if not loadstring then return "unsupported" end
        local f = loadstring("return 123")
        return f() == 123
    end)

    category = "Instance Functions"
    Run(category, "getchildren", function() return #game:GetChildren() > 0 end)
    Run(category, "getdescendants", function() return #game:GetDescendants() > 0 end)
    Run(category, "findfirstchild", function() return game:FindFirstChild("Workspace") ~= nil end)
    Run(category, "findfirstchildofclass", function() return game:FindFirstChildOfClass("Workspace") ~= nil end)
    Run(category, "findfirstancestor", function() return game.Workspace:FindFirstAncestor("game") == game end)

    category = "Require"
    Run(category, "require (existence)", function() return not not require end)
    Run(category, "require (behavior)", function() return not not require end) -- Basic existence check as full behavior varies

    category = "Filesystem"
    Run(category, "writefile", function() return not not writefile end)
    Run(category, "readfile", function() return not not readfile end)
    Run(category, "listfiles", function() return not not listfiles end)
    Run(category, "isfile", function() return not not isfile end)
    Run(category, "isfolder", function() return not not isfolder end)
    Run(category, "makefolder", function() return not not makefolder end)
    Run(category, "delfile", function() return not not delfile end)
    Run(category, "FS I/O Test", function()
        if not writefile or not readfile or not delfile then return "unsupported" end
        local name = "wbt_test.txt"
        writefile(name, "test")
        local content = readfile(name)
        delfile(name)
        return content == "test"
    end)

    category = "Metatable"
    Run(category, "getrawmetatable", function() return getrawmetatable and type(getrawmetatable(game)) == "table" end)
    Run(category, "setrawmetatable", function() return not not setrawmetatable end)
    Run(category, "setreadonly", function() return not not setreadonly end)
    Run(category, "isreadonly", function() return not not isreadonly end)
    Run(category, "getnamecallmethod", function() return not not getnamecallmethod end)
    Run(category, "hookfunction", function() return not not hookfunction end)
    Run(category, "hookmetamethod (behavior)", function()
        if not hookmetamethod then return "unsupported" end
        local t = setmetatable({}, {__index = function() return false end})
        hookmetamethod(t, "__index", function() return true end)
        return t.test
    end)
    Run(category, "newcclosure", function() return not not newcclosure end)
    Run(category, "clonefunction", function() return not not clonefunction end)
    
    category = "Debug"
    Run(category, "debug.getconstants", function() return debug and not not debug.getconstants end)
    Run(category, "debug.getupvalues", function() return debug and not not debug.getupvalues end)
    Run(category, "debug.setupvalue", function() return debug and not not debug.setupvalue end)
    
    category = "Input"
    Run(category, "keypress", function() return not not keypress end)
    Run(category, "mouse1click", function() return not not mouse1click end)
    Run(category, "mouse1click (behavior)", function()
        if not mouse1click then return "unsupported" end
        mouse1click()
        return not UserInputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton1)
    end)

    category = "Crypt/Encoding"
    Run(category, "crypt.encrypt", function() return crypt and not not crypt.encrypt end)
    Run(category, "crypt.hash (sha256)", function() return crypt and crypt.hash and crypt.hash("test", "sha256") or "unsupported" end)
    Run(category, "base64.encode", function() return base64 and not not base64.encode end)
    Run(category, "lz4.compress", function() return lz4 and not not lz4.compress end)

    category = "Drawing"
    local function testDraw(t) 
        if not Drawing then return "unsupported" end
        local o = Drawing.new(t)
        if o then o:Remove() return true end
        return false
    end
    Run(category, "Drawing.new(Line)", function() return testDraw("Line") end)
    Run(category, "Drawing.new(Text)", function() return testDraw("Text") end)
    Run(category, "Drawing.new(Circle)", function() return testDraw("Circle") end)
    Run(category, "Drawing.new(Square)", function() return testDraw("Square") end)

    category = "SUNC / Misc"
    Run(category, "getscriptbytecode", function() return not not getscriptbytecode end)
    Run(category, "gethui", function() return not not gethui end)
    Run(category, "cloneref", function() return not not cloneref end)
    Run(category, "queue_on_teleport", function() return not not queue_on_teleport end)
    Run(category, "setclipboard", function() return not not setclipboard end)
    Run(category, "getcustomasset", function() return not not getcustomasset end)
    Run(category, "identifyexecutor", function() return identifyexecutor and type(identifyexecutor()) == "string" end)
    
    category = "Network"
    Run(category, "request", function() return not not (request or http_request or (http and http.request)) end)
    Run(category, "websocket.connect", function() return websocket and not not websocket.connect end)

    category = "Standard Libs"
    Run(category, "os.clock", function() return os and type(os.clock()) == "number" end)
    Run(category, "io.read", function() return io and not not io.read end)
    Run(category, "coroutine.create", function() return coroutine and not not coroutine.create end)

    category = "Performance"
    Run(category, "Hook Speed", function()
        if not hookfunction then return "unsupported" end
        local f = function() return 1 end
        local start = os.clock()
        hookfunction(f, function() return 2 end)
        local diff = os.clock() - start
        WBT.Info.HookSpeed = diff
        return true
    end)
    Run(category, "Instance Creation Speed", function()
        local start = os.clock()
        for i=1,1000 do Instance.new("Part") end
        local diff = os.clock() - start
        WBT.Info.InstanceSpeed = diff
        return true
    end)
end

function WBT:SerializeJSON(tbl)
    local success, res = pcall(HttpService.JSONEncode, HttpService, tbl)
    if success then return res end
    return "[]"
end

function WBT:GetTestResult(testName)
    for _, category in pairs(WBT.Results) do
        if category[testName] then return category[testName] end
    end
    return "unsupported"
end

function WBT:GenerateCompressedResults()
    local results_string = ""
    local status_map = { pass = "p", fail = "f", unsupported = "u" }
    for _, testName in ipairs(AllTestsOrdered) do
        local status = WBT:GetTestResult(testName) or "unsupported"
        results_string = results_string .. (status_map[status] or "u")
    end
    return results_string
end

function WBT:Submit()
    local payload = {
        info = WBT.Info,
        results = WBT:GenerateCompressedResults(),
        timestamp = os.time()
    }
    
    task.wait(0.2) -- Anti-freeze
    local json = WBT:SerializeJSON(payload)
    local http_func = request or http_request or (http and http.post)
    
    if not http_func then
        GUI:AddLogEntry("Fatal", "fail")
        GUI.StatusLabel.Text = "No HTTP Request function!"
        return
    end
    
    GUI.StatusLabel.Text = "Uploading results..."
    task.wait(0.2) -- Allow text to update
    
    local s, res = pcall(http_func, {
        Url = WBT_SETTINGS.SubmitApiUrl,
        Method = "POST",
        Headers = { ["Content-Type"] = "application/json" },
        Body = json
    })
    
    if s and res and res.Body then
        local decoded = HttpService:JSONDecode(res.Body)
        if decoded and decoded.id then
            local url = WBT_SETTINGS.WebsiteBaseUrl .. "/#scan-" .. decoded.id
            GUI:ShowLink(url)
        else
            GUI.StatusLabel.Text = "Invalid Server Response"
        end
    else
        GUI.StatusLabel.Text = "Submission Failed"
    end
end

function WBT:Main()
    GUI:Create()
    task.wait(0.8)
    GUI:ShowWarning(function()
        GUI:CreateLogView()
        task.spawn(function()
            if not WBT.RunAllTests then
                GUI.StatusLabel.Text = "Critical Error: RunAllTests missing"
                GUI:AddLogEntry("INIT_FAIL", "fail")
                return
            end
            local success, err = pcall(function()
                WBT:RunAllTests()
                WBT:Submit()
            end)
            if not success then
                GUI.StatusLabel.Text = "Error: " .. tostring(err)
            end
        end)
    end)
end

WBT:Main()
