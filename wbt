print("WBT Script Initialized")

local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

local WBT_SETTINGS = {
    WebsiteBaseUrl = "https://worldbt.netlify.app",
    SubmitApiUrl = "https://worldbt.netlify.app/.netlify/functions/submit-scan",
    LogLevel = "Info",
    UseGui = true,
    AutoCopyLink = false,
    TestTimeout = 0.5 -- Seconds to wait before failing a test (prevents freezing)
}

local WBT = {}
WBT.Info = { Executor = "Unknown", Version = "N/A", Level = "N/A" }
WBT.Results = {}
WBT.Logs = {}
WBT.Stats = { Total = 0, Passed = 0 }

-- // UI THEME CONFIG (Pitch Black Theme) // --
local THEME = {
    Background = Color3.fromRGB(0, 0, 0),          -- Pitch Black
    Header = Color3.fromRGB(0, 0, 0),              -- Pitch Black
    ContentBg = Color3.fromRGB(0, 0, 0),           -- Pitch Black
    Text = Color3.fromRGB(255, 255, 255),          -- Pure White
    SubText = Color3.fromRGB(180, 180, 180),       -- Light Gray
    Stroke = Color3.fromRGB(80, 80, 80),           -- Dark Gray Stroke
    Button = Color3.fromRGB(40, 40, 40),           -- Dark Gray Button
    Green = Color3.fromRGB(100, 255, 100),         -- Pass
    Red = Color3.fromRGB(255, 80, 80),             -- Fail
    Yellow = Color3.fromRGB(255, 215, 0),          -- Unsupported
}

-- // LOGGING // --
local function Log(level, ...)
    local message = table.concat({...}, " ")
    table.insert(WBT.Logs, {Level = level, Message = message, Time = os.time()})
    
    local levels = {Debug = 0, Info = 1, Warn = 2, Error = 3}
    if (levels[level] or 1) < (levels[WBT_SETTINGS.LogLevel] or 1) then return end

    local prefix = "[WBT " .. level:upper() .. "]"
    if rconsoleprint then
        pcall(rconsoleprint, prefix .. " " .. message .. "\n")
    else
        print(prefix, message)
    end
end

-- // GUI SYSTEM // --
local GUI = {}
GUI.ScreenGui = nil
GUI.MainFrame = nil
GUI.ContentFrame = nil
GUI.LogList = nil
GUI.ResultsFrame = nil
GUI.ProgressBar = nil
GUI.ProgressFill = nil
GUI.StatusLabel = nil
GUI.PercentageLabel = nil
GUI.ReviewButton = nil

local function Tween(obj, props, time, style, dir)
    if not obj then return end
    local info = TweenInfo.new(time or 0.6, style or Enum.EasingStyle.Exponential, dir or Enum.EasingDirection.Out)
    local tween = TweenService:Create(obj, info, props)
    tween:Play()
    return tween
end

local function Create(class, props, children)
    local obj = Instance.new(class)
    for k, v in pairs(props or {}) do
        obj[k] = v
    end
    for _, child in pairs(children or {}) do
        child.Parent = obj
    end
    return obj
end

function GUI:Create()
    if not WBT_SETTINGS.UseGui then return end
    if GUI.ScreenGui then GUI.ScreenGui:Destroy() end

    local parent = gethui and gethui() or game:GetService("CoreGui")

    -- Main GUI
    GUI.ScreenGui = Create("ScreenGui", {
        Name = "WBT_UI",
        Parent = parent,
        ResetOnSpawn = false,
        DisplayOrder = 999
    })

    -- Main Container
    GUI.MainFrame = Create("Frame", {
        Name = "MainFrame",
        AnchorPoint = Vector2.new(0.5, 0.5),
        Position = UDim2.fromScale(0.5, 0.5),
        Size = UDim2.fromScale(0, 0), -- Start small for tween
        BackgroundColor3 = THEME.Background,
        BorderSizePixel = 0,
        ClipsDescendants = true,
        Parent = GUI.ScreenGui
    }, {
        Create("UICorner", { CornerRadius = UDim.new(0, 10) }),
        Create("UIStroke", { Color = THEME.Stroke, Thickness = 2, Transparency = 0.5 }),
        -- Size Constraint: Fills screen on mobile, limits size on PC
        Create("UISizeConstraint", {
            MaxSize = Vector2.new(600, 450),
            MinSize = Vector2.new(320, 250)
        })
    })

    Tween(GUI.MainFrame, { Size = UDim2.fromScale(0.9, 0.65) }, 0.8, Enum.EasingStyle.Elastic)

    -- Header
    local header = Create("Frame", {
        Name = "Header",
        Size = UDim2.new(1, 0, 0, 40),
        BackgroundColor3 = THEME.Header,
        BorderSizePixel = 0,
        Parent = GUI.MainFrame
    }, {
        Create("TextLabel", {
            Text = "WBT Benchmark",
            Font = Enum.Font.GothamBold,
            TextSize = 16,
            TextColor3 = THEME.Text,
            Size = UDim2.new(1, -50, 1, 0),
            Position = UDim2.new(0, 15, 0, 0),
            BackgroundTransparency = 1,
            TextXAlignment = Enum.TextXAlignment.Left
        })
    })

    -- Close Button
    local closeBtn = Create("TextButton", {
        Text = "×",
        Font = Enum.Font.GothamMedium,
        TextSize = 24,
        TextColor3 = THEME.SubText,
        BackgroundTransparency = 1,
        Size = UDim2.new(0, 40, 1, 0),
        Position = UDim2.new(1, -40, 0, 0),
        Parent = header
    })
    closeBtn.MouseButton1Click:Connect(function()
        Tween(GUI.MainFrame, { Size = UDim2.fromScale(0, 0), Position = UDim2.fromScale(0.5, 0.6) }, 0.4, Enum.EasingStyle.Back, Enum.EasingDirection.In)
        task.wait(0.4)
        GUI.ScreenGui:Destroy()
    end)

    -- Content Area
    GUI.ContentFrame = Create("Frame", {
        Name = "Content",
        Size = UDim2.new(1, -20, 1, -100),
        Position = UDim2.new(0, 10, 0, 50),
        BackgroundTransparency = 1,
        ClipsDescendants = true,
        Parent = GUI.MainFrame
    })

    -- Footer / Progress Area
    local footer = Create("Frame", {
        Name = "Footer",
        Size = UDim2.new(1, -20, 0, 40),
        Position = UDim2.new(0, 10, 1, -50),
        BackgroundTransparency = 1,
        Parent = GUI.MainFrame
    })

    GUI.StatusLabel = Create("TextLabel", {
        Text = "Initializing...",
        Font = Enum.Font.Gotham,
        TextSize = 13,
        TextColor3 = THEME.SubText,
        Size = UDim2.new(0.7, 0, 0.5, 0),
        BackgroundTransparency = 1,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = footer
    })

    GUI.PercentageLabel = Create("TextLabel", {
        Text = "0%",
        Font = Enum.Font.GothamBold,
        TextSize = 13,
        TextColor3 = THEME.Text,
        Size = UDim2.new(0.3, 0, 0.5, 0),
        Position = UDim2.new(0.7, 0, 0, 0),
        BackgroundTransparency = 1,
        TextXAlignment = Enum.TextXAlignment.Right,
        Parent = footer
    })

    GUI.ProgressBar = Create("Frame", {
        Name = "BarBg",
        Size = UDim2.new(1, 0, 0, 6),
        Position = UDim2.new(0, 0, 0.7, 0),
        BackgroundColor3 = Color3.fromRGB(40, 40, 40),
        Parent = footer
    }, { Create("UICorner", { CornerRadius = UDim.new(1, 0) }) })

    GUI.ProgressFill = Create("Frame", {
        Name = "Fill",
        Size = UDim2.new(0, 0, 1, 0),
        BackgroundColor3 = THEME.Text,
        Parent = GUI.ProgressBar
    }, { 
        Create("UICorner", { CornerRadius = UDim.new(1, 0) }),
        Create("UIGradient", { Color = ColorSequence.new(Color3.fromRGB(200, 200, 200), Color3.fromRGB(255, 255, 255)) })
    })

    GUI.ReviewButton = Create("TextButton", {
        Text = "Show Results",
        Font = Enum.Font.GothamBold,
        TextSize = 12,
        TextColor3 = THEME.Background,
        BackgroundColor3 = THEME.SubText,
        Size = UDim2.new(0, 100, 0, 25),
        AnchorPoint = Vector2.new(1, 1),
        Position = UDim2.new(1, 0, -0.2, 0),
        Visible = false,
        Parent = footer
    }, { Create("UICorner", { CornerRadius = UDim.new(0, 4) }) })

    GUI.ReviewButton.MouseButton1Click:Connect(function()
        if GUI.ResultsFrame and GUI.ResultsFrame.Visible then
             GUI:ToggleView("logs")
        else
             GUI:ToggleView("results")
        end
    end)

    -- Dragging
    local dragging, dragInput, dragStart, startPos
    local function update(input)
        local delta = input.Position - dragStart
        GUI.MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
    header.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = GUI.MainFrame.Position
            input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then dragging = false end end)
        end
    end)
    header.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then dragInput = input end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then update(input) end
    end)
end

function GUI:ToggleView(view)
    if not GUI.ResultsFrame or not GUI.LogList then return end
    if view == "results" then
        Tween(GUI.LogList, {Position = UDim2.new(1, 0, 0, 0)}, 0.4, Enum.EasingStyle.Exponential, Enum.EasingDirection.Out)
        task.wait(0.1)
        GUI.ResultsFrame.Visible = true
        GUI.ReviewButton.Text = "Review Logs"
        Tween(GUI.ResultsFrame, {BackgroundTransparency = 0}, 0.3)
    else
        GUI.ResultsFrame.Visible = false
        GUI.LogList.Visible = true
        GUI.ReviewButton.Text = "Show Results"
        Tween(GUI.LogList, {Position = UDim2.new(0, 0, 0, 0)}, 0.4, Enum.EasingStyle.Exponential, Enum.EasingDirection.Out)
    end
end

function GUI:ShowWarning(callback)
    local container = Create("Frame", {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Parent = GUI.ContentFrame
    })

    Create("TextLabel", { Text = "⚠️", TextSize = 40, Size = UDim2.new(1, 0, 0.3, 0), BackgroundTransparency = 1, Parent = container })

    Create("TextLabel", {
        Text = "Heads up!", Font = Enum.Font.GothamBold, TextSize = 22, TextColor3 = THEME.Text,
        Size = UDim2.new(1, 0, 0.2, 0), Position = UDim2.new(0, 0, 0.25, 0), BackgroundTransparency = 1, Parent = container
    })

    Create("TextLabel", {
        Text = "The execution will freeze briefly.\nDo not close the script.",
        Font = Enum.Font.Gotham, TextSize = 14, TextColor3 = THEME.SubText,
        Size = UDim2.new(0.9, 0, 0.3, 0), Position = UDim2.new(0.05, 0, 0.45, 0), BackgroundTransparency = 1, TextWrapped = true, Parent = container
    })

    local btn = Create("TextButton", {
        Text = "Start Benchmark", Font = Enum.Font.GothamBold, TextSize = 14,
        TextColor3 = THEME.Background, BackgroundColor3 = THEME.Text,
        Size = UDim2.new(0.6, 0, 0.15, 0), Position = UDim2.new(0.2, 0, 0.8, 0), Parent = container
    }, { Create("UICorner", { CornerRadius = UDim.new(0, 6) }) })

    btn.MouseButton1Click:Connect(function()
        Tween(container, {Position = UDim2.new(-1, 0, 0, 0)}, 0.5, Enum.EasingStyle.Exponential)
        task.wait(0.3)
        container:Destroy()
        callback()
    end)
end

function GUI:CreateLogView()
    GUI.LogList = Create("ScrollingFrame", {
        Size = UDim2.new(1, 0, 1, 0),
        Position = UDim2.new(1, 0, 0, 0),
        BackgroundTransparency = 1,
        ScrollBarThickness = 3,
        ScrollBarImageColor3 = THEME.SubText,
        AutomaticCanvasSize = Enum.AutomaticSize.Y,
        CanvasSize = UDim2.new(0, 0, 0, 0),
        Parent = GUI.ContentFrame
    }, { Create("UIListLayout", { SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 4) }) })
    Tween(GUI.LogList, {Position = UDim2.new(0, 0, 0, 0)}, 0.5, Enum.EasingStyle.Exponential)
end

function GUI:AddLogEntry(testName, status)
    if not GUI.LogList then return end
    local color, symbol = THEME.SubText, "•"
    if status == "pass" then color, symbol = THEME.Green, "✓"
    elseif status == "fail" then color, symbol = THEME.Red, "✗"
    elseif status == "unsupported" then color, symbol = THEME.Yellow, "?" end

    local row = Create("Frame", { Size = UDim2.new(1, 0, 0, 22), BackgroundTransparency = 1, Parent = GUI.LogList, LayoutOrder = #GUI.LogList:GetChildren() })
    Create("TextLabel", { Text = symbol, TextColor3 = color, Font = Enum.Font.GothamBold, TextSize = 14, Size = UDim2.new(0, 20, 1, 0), BackgroundTransparency = 1, Parent = row })
    Create("TextLabel", { Text = testName, TextColor3 = color, Font = Enum.Font.Gotham, TextSize = 12, Size = UDim2.new(1, -25, 1, 0), Position = UDim2.new(0, 25, 0, 0), BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Left, Parent = row })
    GUI.LogList.CanvasPosition = Vector2.new(0, 99999)
end

function GUI:UpdateProgress(passed, total, currentTest)
    if total == 0 then return end
    local completion = WBT.Stats.Total / 125
    Tween(GUI.ProgressFill, {Size = UDim2.new(math.min(completion, 1), 0, 1, 0)}, 0.2)
    GUI.PercentageLabel.Text = math.floor((passed / math.max(total, 1)) * 100) .. "%"
    if currentTest then GUI.StatusLabel.Text = "Running: " .. currentTest end
end

function GUI:ShowLink(url)
    if not GUI.ContentFrame then return end
    if GUI.LogList then Tween(GUI.LogList, {Position = UDim2.new(1, 0, 0, 0)}, 0.5, Enum.EasingStyle.Exponential, Enum.EasingDirection.Out) end
    
    -- Ensure explicit Pitch Black background for the results container
    GUI.ResultsFrame = Create("Frame", {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        BackgroundColor3 = THEME.Background, 
        Parent = GUI.ContentFrame
    })

    Create("TextLabel", { Text = "Benchmark Complete", Font = Enum.Font.GothamBold, TextSize = 18, TextColor3 = THEME.Text, Size = UDim2.new(1, 0, 0.2, 0), BackgroundTransparency = 1, Parent = GUI.ResultsFrame })

    local box = Create("TextBox", {
        Text = url, Font = Enum.Font.Code, TextSize = 12, TextColor3 = THEME.Text,
        BackgroundColor3 = THEME.Background, -- PITCH BLACK
        Size = UDim2.new(1, 0, 0.25, 0), Position = UDim2.new(0, 0, 0.3, 0),
        ClearTextOnFocus = false, TextEditable = false, TextWrapped = true, Parent = GUI.ResultsFrame
    }, { Create("UICorner", {CornerRadius = UDim.new(0, 6)}), Create("UIStroke", {Color = THEME.Stroke, Thickness = 1}) })
    
    local copyBtn = Create("TextButton", {
        Text = "Copy Link", Font = Enum.Font.GothamBold, TextSize = 14,
        TextColor3 = THEME.Background, BackgroundColor3 = THEME.Text,
        Size = UDim2.new(0.6, 0, 0.15, 0), Position = UDim2.new(0.2, 0, 0.7, 0), Parent = GUI.ResultsFrame
    }, { Create("UICorner", {CornerRadius = UDim.new(0, 6)}) })
    
    copyBtn.MouseButton1Click:Connect(function()
        if setclipboard then
            setclipboard(url)
            copyBtn.Text = "Copied!"
            Tween(copyBtn, {BackgroundColor3 = THEME.Green}, 0.3)
            task.wait(1)
            copyBtn.Text = "Copy Link"
            Tween(copyBtn, {BackgroundColor3 = THEME.Text}, 0.3)
        else
            copyBtn.Text = "Not Supported"
        end
    end)
    
    if GUI.ReviewButton then
        GUI.ReviewButton.Visible = true
        GUI.ReviewButton.Text = "Review Logs"
    end
    
    GUI.StatusLabel.Text = "Finished."
    Tween(GUI.ProgressFill, {Size = UDim2.new(1, 0, 1, 0)}, 0.5)
    Tween(GUI.ResultsFrame, {BackgroundTransparency = 0}, 0.5)
end

-- // CORE LOGIC // --
WBT.Test = {}

-- FULL TEST LIST from prompt
local AllTestsOrdered = {
    "getgenv", "getrenv", "getreg", "getgc", "getinstances", "getnilinstances", "getscripts", "getloadedmodules", "getconnections", "getthreadidentity", "setthreadidentity", "setthreadidentity (behavior)", "firesignal", "fireclickdetector", "firetouchinterest", "is_executor_closure", "is_syn_closure", "checkcaller", "loadstring (behavior)",
    "getchildren", "getdescendants", "findfirstchild", "findfirstchildofclass", "findfirstancestor",
    "require (existence)", "require (behavior)",
    "writefile", "readfile", "appendfile", "loadfile", "listfiles", "isfile", "isfolder", "makefolder", "delfile", "delfolder", "FS I/O Test",
    "getrawmetatable", "setrawmetatable", "getmetatable", "setmetatable", "setreadonly", "isreadonly", "getnamecallmethod", "setnamecallmethod", "hookfunction", "hookfunction (C function)", "hookmetamethod (behavior)", "clonefunction", "newcclosure",
    "debug.getconstants", "debug.getupvalues", "debug.setupvalue", "debug.get/setupvalue (behavior)", "debug.getproto", "debug.setstack", "debug.getmetatable", "debug.setmetatable", "debug.getfenv", "debug.setfenv",
    "rconsoleprint", "rconsoleinfo", "rconsolewarn", "rconsoleerr", "rconsoleclear", "rconsolename", "rconsoleinput",
    "print", "warn", "error", "pcall",
    "keypress", "keyrelease", "mouse1click", "mouse1press", "mouse1release", "mouse1click (behavior)", "mouse2click", "mouse2press", "mouse2release", "mousescroll", "mousemoveabs", "mousemoverel",
    "crypt.encrypt", "crypt.decrypt", "crypt.hash (md5)", "crypt.hash (sha256)", "base64.encode", "base64.decode", "lz4.compress", "lz4.decompress",
    "Drawing.new(Line)", "Drawing.new(Text)", "Drawing.new(Image)", "Drawing.new(Circle)", "Drawing.new(Square)", "Drawing.new(Quad)", "Drawing.new(Triangle)", "Drawing Properties",
    "getscriptbytecode", "getscripthash", "gethui", "cloneref", "queue_on_teleport", "setclipboard", "getclipboard", "set/getclipboard (behavior)", "getcustomasset", "secure_call", "secure_call (behavior)", "getinstancein", "getinstancesin",
    "identifyexecutor", "getexecutorname",
    "bit.band", "bit.bor", "bit.bxor", "bit.lshift", "bit.rshift", "bit.arshift", "bit.not",
    "http_request", "request", "http.get", "http.post",
    "websocket.connect", "websocket.send", "websocket.close", "websocket.on_message", "websocket.on_error",
    "os.execute", "os.remove", "os.rename", "os.exit", "os.clock",
    "io.open", "io.read", "io.write", "io.popen",
    "coroutine.create", "coroutine.resume", "coroutine.yield", "coroutine.wrap",
    "collectgarbage",
    "newinstance.new", "newinstance.create",
    "read_virtual_memory", "write_virtual_memory", "readvmem", "writevmem", "find_pattern", "aob_scan",
    "sethiddenproperty", "gethiddenproperty", "Protected Property Bypass", "ParentLock Bypass",
    "getcallingscript", "getscriptfromthread", "getthreadcontext", "setthreadcontext",
    "luau_load", "iscclosure", "islcclosure",
    "get_fps_cap", "set_fps_cap", "is_synapse_environment", "is_krnl_environment", "is_scriptware_environment", "User-Agent Spoofing",
    "HttpGet", "HttpPost", "GetObjects", "UserSettings", "Stats",
    "debug.debug", "Instance Hiding (getchildren)",
    "Hook Speed", "GC Speed", "Instance Creation Speed"
}

-- UPDATED: TIMEOUT WRAPPER to prevent freezing
function WBT.Test:Run(category, name, testFunc)
    if not WBT.Results[category] then WBT.Results[category] = {} end
    WBT.Stats.Total = WBT.Stats.Total + 1
    
    pcall(GUI.UpdateProgress, GUI, WBT.Stats.Passed, WBT.Stats.Total, name)
    
    local resultStatus = "fail"
    local finished = false
    
    -- Run test in isolated thread
    task.spawn(function()
        local success, res = pcall(testFunc)
        if success then
            if res == "unsupported" then resultStatus = "unsupported"
            elseif res == true then resultStatus = "pass"
            else resultStatus = "fail" end
        else
            resultStatus = "fail" -- Error occurred
        end
        finished = true
    end)
    
    -- Wait loop with Timeout
    local start = os.clock()
    while not finished do
        if os.clock() - start > WBT_SETTINGS.TestTimeout then
            resultStatus = "fail" -- Timeout! Test froze or took too long
            break
        end
        task.wait()
    end
    
    if resultStatus == "pass" then WBT.Stats.Passed = WBT.Stats.Passed + 1 end
    
    -- CONSOLE LOGGING (Requested)
    Log("Info", ("Test: %s -> %s"):format(name, resultStatus:upper()))
    
    pcall(GUI.AddLogEntry, GUI, name, resultStatus)
    WBT.Results[category][name] = resultStatus
end

function WBT:GetExecutorInfo()
    local s, name, ver = pcall(identifyexecutor)
    if s and type(name) == "string" then
        WBT.Info.Executor = name
        if ver then WBT.Info.Version = tostring(ver) else
            local s_ver, ver_alt = pcall(getexecutorversion)
            if s_ver and ver_alt then WBT.Info.Version = tostring(ver_alt) end
        end
    else
        s, name = pcall(getexecutorname)
        if s and type(name) == "string" then WBT.Info.Executor = name
        elseif _G._VERSION then WBT.Info.Executor = _G._VERSION end
    end
    local s_level, level = pcall(getthreadidentity)
    if s_level and level then WBT.Info.Level = tostring(level) end
end

-- Safely attaching RunAllTests to WBT
WBT.RunAllTests = function(self)
    self:GetExecutorInfo()
    local T = self.Test
    local function Run(cat, name, func) T:Run(cat, name, func) end

    -- Core Environment
    local category = "Core Environment"
    Run(category, "getgenv", function() return getgenv and type(getgenv()) == "table" and getgenv()._G == _G end)
    Run(category, "getrenv", function() return getrenv and type(getrenv()) == "table" and getrenv().game == game end)
    Run(category, "getreg", function() return getreg and type(getreg()) == "table" end)
    Run(category, "getgc", function() return getgc and type(getgc()) == "table" end)
    Run(category, "getinstances", function() return getinstances and type(getinstances()) == "table" end)
    Run(category, "getnilinstances", function() return getnilinstances and type(getnilinstances()) == "table" end)
    Run(category, "getscripts", function() return getscripts and type(getscripts()) == "table" end)
    Run(category, "getloadedmodules", function() return getloadedmodules and type(getloadedmodules()) == "table" end)
    Run(category, "getconnections", function() return getconnections and type(getconnections(game:GetService("RunService").Heartbeat)) == "table" end)
    Run(category, "getthreadidentity", function() return getthreadidentity and type(getthreadidentity()) == "number" end)
    Run(category, "setthreadidentity", function() 
        if not setthreadidentity then return "unsupported" end
        pcall(setthreadidentity, 7); pcall(setthreadidentity, 2)
        return true
    end)
    Run(category, "setthreadidentity (behavior)", function()
        if not getthreadidentity or not setthreadidentity then return "unsupported" end
        local old = getthreadidentity()
        setthreadidentity(8); local new = getthreadidentity()
        setthreadidentity(old); return new == 8
    end)
    Run(category, "firesignal", function() return not not firesignal end)
    Run(category, "fireclickdetector", function() return not not fireclickdetector end)
    Run(category, "firetouchinterest", function() return not not firetouchinterest end)
    Run(category, "is_executor_closure", function() return not not is_executor_closure end)
    Run(category, "is_syn_closure", function() return not not is_syn_closure end)
    Run(category, "checkcaller", function() return checkcaller and type(checkcaller()) == "boolean" end)
    Run(category, "loadstring (behavior)", function()
        if not loadstring then return "unsupported" end
        local f = loadstring("return 123")
        return f() == 123
    end)

    -- Instance Functions
    category = "Instance Functions"
    Run(category, "getchildren", function() return #game:GetChildren() > 0 end)
    Run(category, "getdescendants", function() return #game:GetDescendants() > 0 end)
    Run(category, "findfirstchild", function() return game:FindFirstChild("Workspace") ~= nil end)
    Run(category, "findfirstchildofclass", function() return game:FindFirstChildOfClass("Workspace") ~= nil end)
    Run(category, "findfirstancestor", function() return game.Workspace:FindFirstAncestor("game") == game end)

    -- Require
    category = "Require"
    Run(category, "require (existence)", function() return not not require end)
    Run(category, "require (behavior)", function() 
        if not require then return "unsupported" end
        pcall(require, game:GetService("Players")) -- Just verify it doesn't crash on standard roblox objects
        return true 
    end)

    -- Filesystem
    category = "Filesystem (I/O)"
    Run(category, "writefile", function() return not not writefile end)
    Run(category, "readfile", function() return not not readfile end)
    Run(category, "appendfile", function() return not not appendfile end)
    Run(category, "loadfile", function() return not not loadfile end)
    Run(category, "listfiles", function() return not not listfiles end)
    Run(category, "isfile", function() return not not isfile end)
    Run(category, "isfolder", function() return not not isfolder end)
    Run(category, "makefolder", function() return not not makefolder end)
    Run(category, "delfile", function() return not not delfile end)
    Run(category, "delfolder", function() return not not delfolder end)
    Run(category, "FS I/O Test", function()
        if not writefile or not readfile or not delfile then return "unsupported" end
        local name = "wbt_test_"..math.random(999)..".txt"
        writefile(name, "test")
        local content = readfile(name)
        delfile(name)
        return content == "test"
    end)

    -- Metatable & Debugging
    category = "Metatable & Debugging"
    Run(category, "getrawmetatable", function() return getrawmetatable and type(getrawmetatable(game)) == "table" end)
    Run(category, "setrawmetatable", function() return not not setrawmetatable end)
    Run(category, "getmetatable", function() return not not getmetatable end)
    Run(category, "setmetatable", function() return not not setmetatable end)
    Run(category, "setreadonly", function() return not not setreadonly end)
    Run(category, "isreadonly", function() return not not isreadonly end)
    Run(category, "getnamecallmethod", function() return not not getnamecallmethod end)
    Run(category, "setnamecallmethod", function() return not not setnamecallmethod end)
    Run(category, "hookfunction", function() return not not hookfunction end)
    Run(category, "hookfunction (C function)", function()
        if not hookfunction then return "unsupported" end
        local old = hookfunction(game.GetService, function() end)
        hookfunction(game.GetService, old)
        return true
    end)
    Run(category, "hookmetamethod (behavior)", function()
        if not hookmetamethod then return "unsupported" end
        local t = setmetatable({}, {__index = function() return false end})
        hookmetamethod(t, "__index", function() return true end)
        return t.test
    end)
    Run(category, "clonefunction", function() return not not clonefunction end)
    Run(category, "newcclosure", function() return not not newcclosure end)
    
    Run(category, "debug.getconstants", function() return debug and not not debug.getconstants end)
    Run(category, "debug.getupvalues", function() return debug and not not debug.getupvalues end)
    Run(category, "debug.setupvalue", function() return debug and not not debug.setupvalue end)
    Run(category, "debug.get/setupvalue (behavior)", function()
        if not debug or not debug.setupvalue then return "unsupported" end
        local v = 1; local f = function() return v end
        debug.setupvalue(f, 1, 2)
        return f() == 2
    end)
    Run(category, "debug.getproto", function() return debug and not not debug.getproto end)
    Run(category, "debug.setstack", function() return debug and not not debug.setstack end)
    Run(category, "debug.getmetatable", function() return debug and not not debug.getmetatable end)
    Run(category, "debug.setmetatable", function() return debug and not not debug.setmetatable end)
    Run(category, "debug.getfenv", function() return debug and not not debug.getfenv end)
    Run(category, "debug.setfenv", function() return debug and not not debug.setfenv end)

    -- Console
    category = "Console"
    Run(category, "rconsoleprint", function() return not not rconsoleprint end)
    Run(category, "rconsoleinfo", function() return not not rconsoleinfo end)
    Run(category, "rconsolewarn", function() return not not rconsolewarn end)
    Run(category, "rconsoleerr", function() return not not rconsoleerr end)
    Run(category, "rconsoleclear", function() return not not rconsoleclear end)
    Run(category, "rconsolename", function() return not not rconsolename end)
    Run(category, "rconsoleinput", function() return not not rconsoleinput end)

    category = "Standard Console"
    Run(category, "print", function() return true end)
    Run(category, "warn", function() return true end)
    Run(category, "error", function() return not not error end)
    Run(category, "pcall", function() return not not pcall end)

    -- Input
    category = "Input Simulation"
    Run(category, "keypress", function() return not not keypress end)
    Run(category, "keyrelease", function() return not not keyrelease end)
    Run(category, "mouse1click", function() return not not mouse1click end)
    Run(category, "mouse1press", function() return not not mouse1press end)
    Run(category, "mouse1release", function() return not not mouse1release end)
    Run(category, "mouse1click (behavior)", function()
        if not mouse1click then return "unsupported" end
        mouse1click()
        return not UserInputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton1)
    end)
    Run(category, "mouse2click", function() return not not mouse2click end)
    Run(category, "mouse2press", function() return not not mouse2press end)
    Run(category, "mouse2release", function() return not not mouse2release end)
    Run(category, "mousescroll", function() return not not mousescroll end)
    Run(category, "mousemoveabs", function() return not not mousemoveabs end)
    Run(category, "mousemoverel", function() return not not mousemoverel end)

    -- Crypt
    category = "Cryptography & Encoding"
    Run(category, "crypt.encrypt", function() return crypt and not not crypt.encrypt end)
    Run(category, "crypt.decrypt", function() return crypt and not not crypt.decrypt end)
    Run(category, "crypt.hash (md5)", function() return crypt and crypt.hash and crypt.hash("test", "md5") or "unsupported" end)
    Run(category, "crypt.hash (sha256)", function() return crypt and crypt.hash and crypt.hash("test", "sha256") or "unsupported" end)
    Run(category, "base64.encode", function() return base64 and not not base64.encode end)
    Run(category, "base64.decode", function() return base64 and not not base64.decode end)
    Run(category, "lz4.compress", function() return lz4 and not not lz4.compress end)
    Run(category, "lz4.decompress", function() return lz4 and not not lz4.decompress end)

    -- Drawing
    category = "Drawing Library"
    local function testDraw(t) 
        if not Drawing then return "unsupported" end
        local o = Drawing.new(t)
        if o then o:Remove() return true end
        return false
    end
    Run(category, "Drawing.new(Line)", function() return testDraw("Line") end)
    Run(category, "Drawing.new(Text)", function() return testDraw("Text") end)
    Run(category, "Drawing.new(Image)", function() return testDraw("Image") end)
    Run(category, "Drawing.new(Circle)", function() return testDraw("Circle") end)
    Run(category, "Drawing.new(Square)", function() return testDraw("Square") end)
    Run(category, "Drawing.new(Quad)", function() return testDraw("Quad") end)
    Run(category, "Drawing.new(Triangle)", function() return testDraw("Triangle") end)
    Run(category, "Drawing Properties", function() 
        if not Drawing then return "unsupported" end
        local l = Drawing.new("Line")
        if not l then return false end
        l.Visible = false
        l:Remove()
        return true
    end)

    -- SUNC
    category = "SUNC Extensions"
    Run(category, "getscriptbytecode", function() return not not getscriptbytecode end)
    Run(category, "getscripthash", function() return not not getscripthash end)
    Run(category, "gethui", function() return not not gethui end)
    Run(category, "cloneref", function() return not not cloneref end)
    Run(category, "queue_on_teleport", function() return not not queue_on_teleport end)
    Run(category, "setclipboard", function() return not not setclipboard end)
    Run(category, "getclipboard", function() return not not getclipboard end)
    Run(category, "set/getclipboard (behavior)", function()
        if not setclipboard or not getclipboard then return "unsupported" end
        local r = math.random(999); setclipboard(tostring(r)); return getclipboard() == tostring(r)
    end)
    Run(category, "getcustomasset", function() return not not getcustomasset end)
    Run(category, "secure_call", function() return not not secure_call end)
    Run(category, "secure_call (behavior)", function() return not not secure_call end)
    Run(category, "getinstancein", function() return not not getinstancein end)
    Run(category, "getinstancesin", function() return not not getinstancesin end)
    
    -- Exec Info
    category = "Executor Info"
    Run(category, "identifyexecutor", function() return identifyexecutor and type(identifyexecutor()) == "string" end)
    Run(category, "getexecutorname", function() return getexecutorname and type(getexecutorname()) == "string" end)

    -- Bit
    category = "bit Library"
    local b = bit or bit32
    Run(category, "bit.band", function() return b and not not b.band end)
    Run(category, "bit.bor", function() return b and not not b.bor end)
    Run(category, "bit.bxor", function() return b and not not b.bxor end)
    Run(category, "bit.lshift", function() return b and not not b.lshift end)
    Run(category, "bit.rshift", function() return b and not not b.rshift end)
    Run(category, "bit.arshift", function() return b and not not b.arshift end)
    Run(category, "bit.not", function() return b and not not b["not"] end)

    -- HTTP
    category = "http Library"
    Run(category, "http_request", function() return not not http_request end)
    Run(category, "request", function() return not not (request or http_request or (http and http.request)) end)
    Run(category, "http.get", function() return http and not not http.get end)
    Run(category, "http.post", function() return http and not not http.post end)

    -- Websocket
    category = "WebSocket Library"
    Run(category, "websocket.connect", function() return websocket and not not websocket.connect end)
    Run(category, "websocket.send", function() return websocket and not not websocket.send end)
    Run(category, "websocket.close", function() return websocket and not not websocket.close end)
    Run(category, "websocket.on_message", function() return websocket and not not websocket.on_message end)
    Run(category, "websocket.on_error", function() return websocket and not not websocket.on_error end)

    -- Standard Libs (Extended)
    category = "Standard os Library"
    Run(category, "os.execute", function() return os and not not os.execute end)
    Run(category, "os.remove", function() return os and not not os.remove end)
    Run(category, "os.rename", function() return os and not not os.rename end)
    Run(category, "os.exit", function() return os and not not os.exit end)
    Run(category, "os.clock", function() return os and type(os.clock()) == "number" end)

    category = "Standard io Library"
    Run(category, "io.open", function() return io and not not io.open end)
    Run(category, "io.read", function() return io and not not io.read end)
    Run(category, "io.write", function() return io and not not io.write end)
    Run(category, "io.popen", function() return io and not not io.popen end)

    category = "coroutine Library"
    Run(category, "coroutine.create", function() return coroutine and not not coroutine.create end)
    Run(category, "coroutine.resume", function() return coroutine and not not coroutine.resume end)
    Run(category, "coroutine.yield", function() return coroutine and not not coroutine.yield end)
    Run(category, "coroutine.wrap", function() return coroutine and not not coroutine.wrap end)

    category = "Garbage Collector"
    Run(category, "collectgarbage", function() return not not collectgarbage end)

    category = "newinstance Library"
    Run(category, "newinstance.new", function() return newinstance and not not newinstance.new end)
    Run(category, "newinstance.create", function() return newinstance and not not newinstance.create end)

    category = "Advanced Memory"
    Run(category, "read_virtual_memory", function() return not not read_virtual_memory end)
    Run(category, "write_virtual_memory", function() return not not write_virtual_memory end)
    Run(category, "readvmem", function() return not not readvmem end)
    Run(category, "writevmem", function() return not not writevmem end)
    Run(category, "find_pattern", function() return not not find_pattern end)
    Run(category, "aob_scan", function() return not not aob_scan end)

    category = "Access Control"
    Run(category, "sethiddenproperty", function() return not not sethiddenproperty end)
    Run(category, "gethiddenproperty", function() return not not gethiddenproperty end)
    Run(category, "Protected Property Bypass", function()
        if not sethiddenproperty then return "unsupported" end
        local p = Instance.new("Part"); sethiddenproperty(p, "Name", "Test"); return p.Name == "Test"
    end)
    Run(category, "ParentLock Bypass", function() return false end) -- Hard to safely test without freezing

    category = "Obscure Thread/Debug"
    Run(category, "getcallingscript", function() return not not getcallingscript end)
    Run(category, "getscriptfromthread", function() return not not getscriptfromthread end)
    Run(category, "getthreadcontext", function() return not not getthreadcontext end)
    Run(category, "setthreadcontext", function() return not not setthreadcontext end)

    category = "Advanced Luau"
    Run(category, "luau_load", function() return not not luau_load end)
    Run(category, "iscclosure", function() return not not iscclosure end)
    Run(category, "islcclosure", function() return not not islcclosure end)

    category = "Environment Spoofing"
    Run(category, "get_fps_cap", function() return not not get_fps_cap end)
    Run(category, "set_fps_cap", function() return not not set_fps_cap end)
    Run(category, "is_synapse_environment", function() return not not is_synapse_environment end)
    Run(category, "is_krnl_environment", function() return not not is_krnl_environment end)
    Run(category, "is_scriptware_environment", function() return not not is_scriptware_environment end)
    Run(category, "User-Agent Spoofing", function() return false end)

    category = "Obscure Globals"
    Run(category, "HttpGet", function() return not not HttpGet end)
    Run(category, "HttpPost", function() return not not HttpPost end)
    Run(category, "GetObjects", function() return not not GetObjects end)
    Run(category, "UserSettings", function() return not not UserSettings end)
    Run(category, "Stats", function() return not not Stats end)

    category = "Anti-Detection"
    Run(category, "debug.debug", function() return debug and not not debug.debug end)
    Run(category, "Instance Hiding (getchildren)", function() return false end) -- Complex to test safely

    -- Performance
    category = "Performance Benchmarking"
    Run(category, "Hook Speed", function()
        if not hookfunction then return "unsupported" end
        local f = function() return 1 end
        local start = os.clock()
        hookfunction(f, function() return 2 end)
        local diff = os.clock() - start
        WBT.Info.HookSpeed = diff
        return true
    end)
    Run(category, "GC Speed", function() 
        if not getgc then return "unsupported" end
        local start = os.clock(); getgc(); return true
    end)
    Run(category, "Instance Creation Speed", function()
        local start = os.clock()
        for i=1,1000 do Instance.new("Part") end
        local diff = os.clock() - start
        WBT.Info.InstanceSpeed = diff
        return true
    end)
end

function WBT:SerializeJSON(tbl)
    local success, res = pcall(HttpService.JSONEncode, HttpService, tbl)
    if success then return res end
    return "[]"
end

function WBT:GetTestResult(testName)
    for _, category in pairs(WBT.Results) do
        if category[testName] then return category[testName] end
    end
    return "unsupported"
end

function WBT:GenerateCompressedResults()
    local results_string = ""
    local status_map = { pass = "p", fail = "f", unsupported = "u" }
    for _, testName in ipairs(AllTestsOrdered) do
        local status = WBT:GetTestResult(testName) or "unsupported"
        results_string = results_string .. (status_map[status] or "u")
    end
    return results_string
end

function WBT:Submit()
    local payload = {
        info = WBT.Info,
        results = WBT:GenerateCompressedResults(),
        timestamp = os.time()
    }
    
    task.wait(0.2) -- Anti-freeze
    local json = WBT:SerializeJSON(payload)
    local http_func = request or http_request or (http and http.post)
    
    if not http_func then
        GUI:AddLogEntry("Fatal", "fail")
        GUI.StatusLabel.Text = "No HTTP Request function!"
        return
    end
    
    GUI.StatusLabel.Text = "Uploading results..."
    task.wait(0.2) -- Allow text to update
    
    local s, res = pcall(http_func, {
        Url = WBT_SETTINGS.SubmitApiUrl,
        Method = "POST",
        Headers = { ["Content-Type"] = "application/json" },
        Body = json
    })
    
    if s and res and res.Body then
        local decoded = HttpService:JSONDecode(res.Body)
        if decoded and decoded.id then
            local url = WBT_SETTINGS.WebsiteBaseUrl .. "/#scan-" .. decoded.id
            GUI:ShowLink(url)
        else
            GUI.StatusLabel.Text = "Invalid Server Response"
        end
    else
        GUI.StatusLabel.Text = "Submission Failed"
    end
end

function WBT:Main()
    GUI:Create()
    task.wait(0.8)
    GUI:ShowWarning(function()
        GUI:CreateLogView()
        task.spawn(function()
            if not WBT.RunAllTests then
                GUI.StatusLabel.Text = "Critical Error: RunAllTests missing"
                GUI:AddLogEntry("INIT_FAIL", "fail")
                return
            end
            local success, err = pcall(function()
                WBT:RunAllTests()
                WBT:Submit()
            end)
            if not success then
                GUI.StatusLabel.Text = "Error: " .. tostring(err)
            end
        end)
    end)
end

WBT:Main()
